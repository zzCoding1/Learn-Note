## 3.fastDFS

 

### 3.1 fastDFS介绍

1. fastDFS 概述

   > * 用**C语言** 编写
   > * 充分考虑冗余备份、负载均衡、线性扩容、高可用、高性能
   >   * 冗余备份：纵向扩容
   >   * 线性扩容：横向扩容
   > * 可以很容易搭建一套高性能服务器集群，提供文件**上传**、 **下载**等服务。
   >   * 图床
   >   * 网盘

2. fastDFS框架中的三个角色（**进程**）

   - 追踪器（**Tracker**） - 管理者（**守护进程**：周期性执行某个任务）
     - 管理存储节点
   - 存储节点 - storage （**守护进程**）
     - 存储节点是有多个的
   - 客户端 - 不是守护进程，由程序员编写的程序
     - 文件上传
     - 文件下载

   ```mermaid
   sequenceDiagram
   Storgae Server -->> Tracker Server : 1.定时向tracker上传状态信息
   Client ->> Tracker Server : 2.下载连接请求
   Tracker Server ->> Tracker Server : 3.查询可用Storage（检查同步状态）
   Tracker Server -->> Client : 4.返回信息（storage的ip端口）
   Client ->> Storgae Server : 5.file_id(组名，路径，文件名)
   Storgae Server -->> Client : 6.返回file_content
   ```

   1. 追踪器
      - 最先启动追踪器
   2. 存储节点
   
       - 第二个启动的角色
       - 存储节点启动后，会单独开一个县城
         - 汇报当前存储节点的容量，和剩余的容量。
         - 汇报数据的同步情况
         - 汇报数据被下载的次数
     3. 客户端
        - 最后启动 
          - 上传
            - 连接追踪器，询问存储节点的信息。
              - 我要上传1G的文件，哪个存储节点有足够的容量
              - 追踪器查询，得到结果
              - 追踪器将存储节点的**IP**和**Port**发送给客户端
              - 通过**IP**和**Port**连接存储节点
              - 将文件内容发送给存储节点
          - 下载
            - 连接追踪器，询问存储节点信息
              - 问一下，要下载的文件在哪个存储节点
              - 追踪器查询，得到结果
              - 追踪器将存储节点的**IP**和**Port**发送给客户端
              - 通过**IP**和**Port**连接存储节点
              - 下载文件
     4. fastDFS集群（了解即可）
   
   ![image-20220704234229126](assets/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/image-20220704234229126.png)
   
   1. 追踪器集群
          - 为什么集群
            - 避免单点故障
              - 多个Tracker如何工作？
            - 轮询工作
              - 如何实现集群？
            - **修改配置文件**
      
       2. 存储节点集群
          - fastDFS管理存储节点的方式?
            - 分组的方式
          - 集群方式（扩容方式）
            - 横向扩容 - 增加容量
              - 添加一台新的主机->容量增加了
              - 加入当前有两个组：group1，group2
                - 需要添加一个新的分组->group3
                  - 新主机属于第三组
              - 不同组的主机之间不需要通信。
            - 纵向扩容 - 数据备份
              - 将新的主机放到现有的组中
              - 每个组的主机数从1->N
                - 这n台主机的关系就是相互备份的关系
                - 同一个组内的主机需要通信
                - 每组的容量 = 组中最小的那台的容量
          - 如何实现？
            - 通过修改配置文件的方式可实现

### 3.2 fastDFS的安装

1. fastDFS安装
   - libfastcommon-1.36.zip
     - fastdfs的基础库包
     - unzip xxx.zip
   - fastdfs-5.10.tar.gz
     - tar zxvf  xxx.tar.gz
2. 测试

   - bin` 目录下的 *_text
   - echo $PATH ：bash路径

   ```shell
   fastDFS安装的所有可执行程序
   /usr/bin/fdfs_*
   fdsf_test3.3 fastDFS配置文档
   ```

### 3.3 fastDFS 配置文件

> 配置文件默认位置/etc/fdfs (==**改配置文件要备份！！！**==)
>
> client.conf.sample  storage.conf.sample  storage_ids.conf.sample  tracker_conf.sample  
>
> - 配置文件一般用 `#` 作为注释

 1. tracker 配置文件

    ```shell
    # 将追踪器和部署主机的IP地址进行绑定，也可以不写
    # 如果不指定，会自动绑定当前主机IP地址，如果是云服务器，建议不要写
    bind_addr=192.168.247.135
    # 追踪器监听的端口
    port=22122
    # 检测守护进程问题要打印日志。
    # 追踪器存储日志信息的目录，xxx.pid文件必须是一个存在的目录 
    base_path=/home/yuqing/fastdfs
    ```

    

	2. storage 配置文件
	2. 客户端配置文件

## 5.源码安装

安装流程

1. 以下文件，里面有安装步骤
   - readme
   - readme.md
   - INSTALL
2. 找可执行文件 **configure**
   - 执行这个可执行文件
     - 检测安装环境
     - 生成makefile
3. 执行**make**命令
   - 编译源代码
     - 生成了动态库
     - 静态库
     - 可执行程序
4. 安装 **make install** （需要管理员权限）
   - 将第三部生成的动态库/静态库/可执行程序**拷贝**到对应的系统目录
   - `/etc` **linux**配置文件目录
